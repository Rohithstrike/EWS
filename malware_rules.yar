rule HighRiskRansomware {
    meta:
        severity = "critical"
        description = "Detection of high-risk ransomware, including advanced persistent threats (APTs) leveraging encryption techniques and anti-analysis tactics"
        threat_type = "ransomware"
        author = "Enhanced by AI"
        date = "2024-10-28"

    strings:
        $ransom_ext = /(\.locked|\.crypt|\.ransom|\.enc|\.encfile|\.pay|\.paycrypt|\.locky|\.jjf|\.jjg|\.xyz)$/
        $ransom_note = /Your files have been encrypted|All your data is locked|Decryptor will cost|ransomware notice|Pay the ransom to get your files back|Your documents are unsafe|Contact us at/
        $encryption_calls = /AES|RSA|DES|Blowfish|ChaCha20|Twofish|XTEA|Serpent/
        $encoded_c2_http = {68 74 74 70 3A 2F 2F}
        $encoded_c2_https = {68 74 74 70 73 3A 2F 2F}
        $obfuscated_cmd = "cmd.exe /c start"
        $shutdown_cmd = /shutdown(.*)\/f|bcdedit\/set|powercfg -h off|taskkill \/F \/IM|del \/F \/S \/Q/
        $shadow_delete = "vssadmin delete shadows /all /quiet"
        $reg_persistence = "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run|HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
        $anti_analysis = /sleep\((\d+|.*)\)|sandbox|debugger|GetModuleHandleA|IsDebuggerPresent|CheckRemoteDebuggerPresent/
        $anti_debug = /int 3|__debugbreak|GetTickCount|QueryPerformanceCounter|SetUnhandledExceptionFilter|UnhandledExceptionFilter/
        $mutex_creation = /CreateMutexA|CreateMutexW|Global\\[a-zA-Z0-9]{8}/
        $file_wipe = /cipher \/w|sdelete|del \*\.bak|del \*\.old/
        $process_inject = /CreateRemoteThread|OpenProcess|VirtualAllocEx|WriteProcessMemory|CreateProcessA|CreateProcessW/
        $persistence_scripts = /reg add HKLM|powershell -exec bypass/

    condition:
        ($ransom_ext or $ransom_note or $shadow_delete) and
        ($encoded_c2_http or $encoded_c2_https or $reg_persistence or $obfuscated_cmd or $encryption_calls or $shutdown_cmd or $anti_analysis or $anti_debug or $mutex_creation or $file_wipe or $process_inject or $persistence_scripts)
}

rule ZeroDayExploit {
    meta:
        severity = "high"
        description = "Detection of zero-day exploit attempts with buffer overflow, shellcode, privilege escalation, and common CVE exploit patterns"
        threat_type = "zero_day_exploit"
        author = "Enhanced by AI"
        date = "2024-10-28"

    strings:
        $overflow_pattern = /(\x90{10,})/
        $shellcode = {31 c0 50 68 2f 2f 73 68 68 2f 62 69 6e 89 e3|6a 0b 58 99 52 57 68 2f 2f 73 68 68 2f 62 69 6e 89 e3}
        $priv_escalation = /seDebugPrivilege|seTakeOwnershipPrivilege|seBackupPrivilege|seRestorePrivilege|createProcessWithLogonW|CreateRemoteThread|AdjustTokenPrivileges/
        $cmd_injection = /&&|\|\||;|\$\(.*\)|\`.*\`|;|\/c|\/k|\/p/
        $encoded_payload = /([a-zA-Z0-9\+\/=]{20,})/
        $known_cves = /CVE\-(2023|2024)\-\d{4,5}|MS[0-9]{4}-[0-9]{3}|CVE\-\d{4}\-\d{4}/
        $memory_corruption = /mov eax, esp|jmp esp|xor eax, eax|xor ecx, ecx|call eax|pop eax|push eax|inc eax|dec eax/
        $api_exploit = /VirtualAllocEx|WriteProcessMemory|ZwMapViewOfSection|HeapAlloc/
        $exploit_payload = /malicious_payload|exploit_code|shell_spawn/
        $sandbox_check = /sandbox|debugger|vmware/

    condition:
        any of ($overflow_pattern, $shellcode, $priv_escalation, $cmd_injection, $encoded_payload, $known_cves, $memory_corruption, $api_exploit, $exploit_payload, $sandbox_check)
}

rule MediumRiskMalware {
    meta:
        severity = "medium"
        description = "Detection of medium-risk malware showing suspicious behavior, including fileless techniques and command-and-control"
        threat_type = "generic_malware"
        author = "Enhanced by AI"
        date = "2024-10-28"

    strings:
        $malicious_string = "malicious_payload|hidden_execute"
        $fileless_powershell = /powershell.exe -WindowStyle hidden -EncodedCommand|powershell -nop -c/
        $suspicious_file_ext = {2E 74 78 74|2E 6D 73 67}
        $remote_script = /wget|curl http(s)?:\/\/\S+|Invoke-WebRequest/
        $suspicious_url = /http(s)?:\/\/(malicious|phish)\.[a-z0-9\-]+\.(com|net|org|io|biz)/
        $file_encrypt_attempt = /CryptographicBuffer|EncryptData|CryptEncrypt|CryptDecrypt|SecureString/
        $win_registry_run = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run|HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
        $hidden_cmd = /cmd\.exe \/c hide|powershell -windowstyle hidden/
        $suspicious_child_process = /wscript|cscript|mshta|bitsadmin|regsvr32/
        $file_obfuscation = /base64_decode|encoded_data|obfuscated_string/

    condition:
        any of ($malicious_string, $fileless_powershell, $suspicious_file_ext, $remote_script, $suspicious_url, $file_encrypt_attempt, $win_registry_run, $hidden_cmd, $suspicious_child_process, $file_obfuscation)
}

rule LowRiskInfoGathering {
    meta:
        severity = "low"
        description = "Detection of low-risk malware or info-gathering techniques, including basic network commands and debug artifacts"
        threat_type = "info_gathering"
        author = "Enhanced by AI"
        date = "2024-10-28"

    strings:
        $low_risk_string = "low_risk_malware_pattern|info_gathering_tool"
        $info_cmd = /whoami|hostname|ipconfig|ifconfig|netstat|net user|arp|route print|tracert/
        $suspicious_extension = /\.(tmp|bak|swp|log|old|ini)$/
        $suspicious_var = /[A-Za-z0-9]+_debug|debugger|tempVar/
        $network_scan = /ping|nslookup|tracert|net view|arp -a|route|curl/
        $exfil_protocol = /ftp|smb|ldap|tftp/
        $sys_info_gather = /systeminfo|tasklist|driverquery|sc query|query user/
        $log_file_patterns = /log|debug|trace|history/

    condition:
        any of ($low_risk_string, $info_cmd, $suspicious_extension, $suspicious_var, $network_scan, $exfil_protocol, $sys_info_gather, $log_file_patterns)
}
