rule HighRiskRansomware {
    meta:
        severity = "critical"
        description = "Detection of high-risk ransomware, including APTs using advanced encryption and anti-analysis techniques"
        threat_type = "ransomware"
        author = "Enhanced by AI"
        date = "2024-10-31"
        last_modified = "2024-11-01"

    strings:
        // File extensions commonly associated with ransomware
        $ransom_ext = /(\.locked|\.crypt|\.ransom|\.enc|\.encfile|\.pay|\.paycrypt|\.locky|\.jjf|\.jjg|\.xyz)$/
        // Common ransom note phrases
        $ransom_note = /Your files have been encrypted|All your data is locked|Decryptor will cost|ransomware notice|Pay the ransom to get your files back|Contact us at|This is not a scam|Your documents are unsafe/
        // Encryption algorithms and function calls
        $encryption_calls = /AES|RSA|DES|Blowfish|ChaCha20|Twofish|XTEA|Serpent|Encrypt|Decrypt/
        // Patterns indicating communication with malicious C2 servers
        $encoded_c2_http = {68 74 74 70 3A 2F 2F}
        $encoded_c2_https = {68 74 74 70 73 3A 2F 2F}
        // Command execution patterns
        $obfuscated_cmd = "cmd.exe /c start"
        // Malicious shutdown or file deletion commands
        $shutdown_cmd = /shutdown(.*)\/f|bcdedit\/set|powercfg -h off|taskkill \/F \/IM|del \/F \/S \/Q|format c:\/q/
        $shadow_delete = "vssadmin delete shadows /all /quiet|vssadmin delete shadows /for=d: /all|wmic shadowcopy delete"
        // Registry persistence techniques
        $reg_persistence = /HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run|HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run|HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce/
        // Anti-analysis and debugging checks
        $anti_analysis = /sleep\((\d+|.*)\)|sandbox|debugger|GetModuleHandleA|IsDebuggerPresent|CheckRemoteDebuggerPresent|NtQueryInformationProcess/
        $anti_debug = /int 3|__debugbreak|GetTickCount|QueryPerformanceCounter|SetUnhandledExceptionFilter|UnhandledExceptionFilter|IsDebuggerPresent|DebugActiveProcess/
        // Mutex creation patterns indicating potential malware behavior
        $mutex_creation = /CreateMutexA|CreateMutexW|Global\\[a-zA-Z0-9]{8,}/
        // Patterns for file wiping techniques
        $file_wipe = /cipher \/w|sdelete|del \*\.bak|del \*\.old|shred|wipe|rm -rf/
        // Process injection techniques
        $process_inject = /CreateRemoteThread|OpenProcess|VirtualAllocEx|WriteProcessMemory|CreateProcessA|CreateProcessW|SetWindowsHookEx/
        // Scripts for persistence and remote execution
        $persistence_scripts = /reg add HKLM|powershell -exec bypass|Invoke-WebRequest|New-Object Net.WebClient/
        // Indicators of malicious behavior in temp directories
        $malicious_behavior = /C:\Windows\Temp|C:\Users\\.*\\AppData\\Local\\Temp|C:\ProgramData\\.*\\|C:\Windows\System32/
        // Additional patterns for known ransomware strains
        $known_ransomware_strings = /LockBit|REvil|Maze|Sodinokibi|Dharma|GandCrab|Cryptowall/

    condition:
        ($ransom_ext or $ransom_note or $shadow_delete or $known_ransomware_strings) and
        ($encoded_c2_http or $encoded_c2_https or $reg_persistence or $obfuscated_cmd or $encryption_calls or $shutdown_cmd or $anti_analysis or $anti_debug or $mutex_creation or $file_wipe or $process_inject or $persistence_scripts or $malicious_behavior)
}

rule ZeroDayExploit {
    meta:
        severity = "high"
        description = "Detection of zero-day exploit attempts including buffer overflow, shellcode, privilege escalation, and CVE patterns"
        threat_type = "zero_day_exploit"
        author = "Enhanced by AI"
        date = "2024-10-31"
        last_modified = "2024-11-01"

    strings:
        // Buffer overflow and NOP sled patterns
        $overflow_pattern = /(\x90{10,})|(\x41\x41\x41\x41|\x42\x42\x42\x42)/
        // Common shellcode patterns
        $shellcode = {31 c0 50 68 2f 2f 73 68 68 2f 62 69 6e 89 e3|6a 0b 58 99 52 57 68 2f 2f 73 68 68 2f 62 69 6e 89 e3|cc cc cc cc}
        // Privilege escalation techniques
        $priv_escalation = /seDebugPrivilege|seTakeOwnershipPrivilege|seBackupPrivilege|seRestorePrivilege|createProcessWithLogonW|CreateRemoteThread|AdjustTokenPrivileges|TokenPrivileges/
        // Command injection patterns
        $cmd_injection = /&&|\|\||;|\$\(.*\)|\`.*\`|;|\/c|\/k|\/p|cmd\/c/
        // Base64 encoded payloads
        $encoded_payload = /([a-zA-Z0-9\+\/=]{20,})|base64\.decode/
        // Known CVEs and security vulnerabilities
        $known_cves = /CVE\-(2023|2024)\-\d{4,5}|MS[0-9]{4}-[0-9]{3}|CVE\-\d{4}\-\d{4}/
        // Memory corruption patterns
        $memory_corruption = /mov eax, esp|jmp esp|xor eax, eax|xor ecx, ecx|call eax|pop eax|push eax|inc eax|dec eax|lea eax, [esp+0x4]/
        // Exploitation API calls
        $api_exploit = /VirtualAllocEx|WriteProcessMemory|ZwMapViewOfSection|HeapAlloc|NtCreateThreadEx/
        // Generic exploit payload markers
        $exploit_payload = /malicious_payload|exploit_code|shell_spawn|execute_payload/
        // Sandbox detection techniques
        $sandbox_check = /sandbox|debugger|vmware|QEMU/
        // Additional patterns for exploit kits and frameworks
        $exploit_kit_patterns = /Angler|Neutrino|Rig|Magnitude|Goon/

    condition:
        any of ($overflow_pattern, $shellcode, $priv_escalation, $cmd_injection, $encoded_payload, $known_cves, $memory_corruption, $api_exploit, $exploit_payload, $sandbox_check, $exploit_kit_patterns)
}

rule MediumRiskMalware {
    meta:
        severity = "medium"
        description = "Detection of medium-risk malware showing suspicious behavior, including fileless techniques and command-and-control"
        threat_type = "generic_malware"
        author = "Enhanced by AI"
        date = "2024-10-31"
        last_modified = "2024-11-01"

    strings:
        // Common malicious strings and payloads
        $malicious_string = /malicious_payload|hidden_execute|cmd.exe\/c|powershell.exe -exec bypass/
        // Fileless PowerShell patterns
        $fileless_powershell = /powershell\.exe -WindowStyle hidden -EncodedCommand|powershell -nop -c|powershell -e|Invoke-Expression/
        // Suspicious file extensions
        $suspicious_file_ext = {2E 74 78 74|2E 6D 73 67|2E 63 6F 6D|2E 70 79|2E 62617365}
        // Remote script execution patterns
        $remote_script = /wget|curl http(s)?:\/\/\S+|Invoke-WebRequest|bash -c|sh -c/
        // Known suspicious URLs
        $suspicious_url = /http(s)?:\/\/(malicious|phish)\.[a-z0-9\-]+\.(com|net|org|io|biz|info|me)/
        // File encryption attempts
        $file_encrypt_attempt = /CryptographicBuffer|EncryptData|CryptEncrypt|CryptDecrypt|SecureString|AesEncrypt|AesDecrypt/
        // Registry run keys for persistence
        $win_registry_run = /HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run|HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run|HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce/
        // Hidden command execution patterns
        $hidden_cmd = /cmd\.exe \/c hide|powershell -windowstyle hidden/
        // Remote access patterns
        $remote_access = /Remote Access Trojan|RAT|backdoor|access remote|C2 server/

    condition:
        any of ($malicious_string, $fileless_powershell, $suspicious_file_ext, $remote_script, $suspicious_url, $file_encrypt_attempt, $win_registry_run, $hidden_cmd, $remote_access)
}

rule LowRiskMalware {
    meta:
        severity = "low"
        description = "Detection of low-risk malware showing benign behavior but potentially unwanted actions."
        threat_type = "low_risk_malware"
        author = "Enhanced by AI"
        date = "2024-10-31"
        last_modified = "2024-11-01"

    strings:
        // Patterns for unwanted software installation
        $unwanted_software = /installing software|setup.exe|unwanted tool|adware|PUP/
        // Common adware behavior
        $adware_behavior = /popups|ads|banner|advertisement|promotional content|install updates/
        // Registry modifications for benign applications
        $benign_registry = /HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall|HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall/
        // Common benign file extensions
        $benign_extensions = {2E 6C 6F 67|2E 68 74 6D|2E 66 72 6F|2E 64 6C 6C|2E 6D 73 69|2E 63 78 6C}
        // Patterns for non-malicious scripting languages
        $script_patterns = /javascript|VBScript|batch file|shell script/
        // User behavior patterns indicating potential unwanted actions
        $user_interaction = /user consent|opt-in|opt-out|end user license agreement/

    condition:
        any of ($unwanted_software, $adware_behavior, $benign_registry, $benign_extensions, $script_patterns, $user_interaction)
}

rule MediumRiskMalware {
    meta:
        severity = "medium"
        description = "Detection of medium-risk malware showing suspicious behavior, including fileless techniques and command-and-control."
        threat_type = "medium_risk_malware"
        author = "Enhanced by AI"
        date = "2024-10-31"
        last_modified = "2024-11-01"

    strings:
        // Common malicious strings and payloads
        $malicious_string = /malicious_payload|hidden_execute|cmd.exe\/c|powershell.exe -exec bypass/
        // Fileless PowerShell patterns
        $fileless_powershell = /powershell\.exe -WindowStyle hidden -EncodedCommand|powershell -nop -c|powershell -e|Invoke-Expression/
        // Suspicious file extensions
        $suspicious_file_ext = {2E 74 78 74|2E 6D 73 67|2E 63 6F 6D|2E 70 79|2E 62617365}
        // Remote script execution patterns
        $remote_script = /wget|curl http(s)?:\/\/\S+|Invoke-WebRequest|bash -c|sh -c/
        // Known suspicious URLs
        $suspicious_url = /http(s)?:\/\/(malicious|phish)\.[a-z0-9\-]+\.(com|net|org|io|biz|info|me)/
        // File encryption attempts
        $file_encrypt_attempt = /CryptographicBuffer|EncryptData|CryptEncrypt|CryptDecrypt|SecureString|AesEncrypt|AesDecrypt/
        // Registry run keys for persistence
        $win_registry_run = /HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run|HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run|HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce/
        // Hidden command execution patterns
        $hidden_cmd = /cmd\.exe \/c hide|powershell -windowstyle hidden/
        // Remote access patterns
        $remote_access = /Remote Access Trojan|RAT|backdoor|access remote|C2 server/

    condition:
        any of ($malicious_string, $fileless_powershell, $suspicious_file_ext, $remote_script, $suspicious_url, $file_encrypt_attempt, $win_registry_run, $hidden_cmd, $remote_access)
}
